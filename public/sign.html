<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cell Noun - Authentication</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Header styles - Hidden on mobile */
        .header {
            width: 100%;
            background-color: #2c3e50;
            color: white;
            position: fixed;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .top-left, .top-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .top-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.3s;
            position: relative;
        }

        .top-link:hover {
            color: #3498db;
        }

        .top-link.active {
            color: #3498db;
        }

        .top-link.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #3498db;
        }

        .slash {
            color: #7f8c8d;
            margin: 0 5px;
        }

        /* Hide header on mobile */
        @media (max-width: 768px) {
            .header {
                display: none;
            }
        }

        /* Full screen container */
        .fullscreen-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Back arrow navigation */
        .back-arrow {
            padding: 20px 24px;
            position: absolute;
            top: 50px;
            left: 0;
            z-index: 10;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .back-link:hover {
            background-color: #3498db;
            color: white;
            transform: translateX(-5px);
        }

        .back-link i {
            font-size: 1.1rem;
        }

        /* Main authentication area */
        .auth-main {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            min-height: calc(100vh - 150px);
            width: 100%;
        }

        .auth-page {
            display: none;
            width: 100%;
            max-width: 480px;
            animation: fadeIn 0.5s ease;
        }

        .auth-page.active {
            display: block;
        }

        .auth-wrapper {
            background-color: white;
            border-radius: 16px;
            padding: 40px 32px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            width: 100%;
            margin: 0 auto;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #666;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Verification Specific Styles */
        .verification-icon {
            text-align: center;
            margin-bottom: 20px;
        }

        .verification-icon i {
            font-size: 3rem;
            color: #3498db;
        }

        .verification-subtitle {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Form styles */
        .auth-form {
            width: 100%;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .password-label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-icon i {
            position: absolute;
            left: 16px;
            color: #666;
            font-size: 1.1rem;
            z-index: 1;
        }

        .input-with-icon input,
        .input-with-icon select {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s ease;
            appearance: none;
            background-color: white;
        }

        .input-with-icon select {
            cursor: pointer;
            color: #333;
        }

        .input-with-icon select:invalid {
            color: #999;
        }

        .input-with-icon input:focus,
        .input-with-icon select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Password input with toggle */
        .input-with-icon input[type="password"],
        .input-with-icon input[type="text"] {
            padding-right: 50px;
        }

        .toggle-password {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
            z-index: 2;
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: #3498db;
        }

        /* Disabled state */
        .input-with-icon input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Verification Code Input */
        .verification-code-input {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .verification-code-input input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: white;
            transition: all 0.3s;
        }

        .verification-code-input input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .verification-code-input input.filled {
            border-color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.1);
        }

        .verification-code-input input.verified {
            border-color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.1);
        }

        /* Error messages */
        .error-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 6px;
            min-height: 20px;
        }

        .error-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Forgot password link */
        .forgot-password {
            color: #3498db;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.3s;
            font-weight: 500;
        }

        .forgot-password:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        /* Submit button */
        .submit-btn {
            width: 100%;
            padding: 16px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .submit-btn:hover {
            background-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* Auth footer */
        .auth-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        .auth-footer p {
            color: #666;
            font-size: 0.95rem;
        }

        .auth-footer a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* Success message */
        .success-message {
            text-align: center;
            padding: 20px 0;
        }

        .success-icon {
            font-size: 4rem;
            color: #2ecc71;
            margin-bottom: 20px;
        }

        .success-message h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .success-message p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Password Strength Indicator */
        .password-strength {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .strength-label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .strength-meter {
            height: 6px;
            background-color: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            background-color: #e74c3c;
            border-radius: 3px;
            transition: width 0.3s, background-color 0.3s;
        }

        .strength-bar.weak {
            width: 33%;
            background-color: #e74c3c;
        }

        .strength-bar.medium {
            width: 66%;
            background-color: #f39c12;
        }

        .strength-bar.strong {
            width: 100%;
            background-color: #2ecc71;
        }

        .strength-text {
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        /* Main footer */
        .auth-footer-main {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            width: 100%;
            margin-top: auto;
        }

        .auth-footer-main a {
            color: #3498db;
            text-decoration: none;
        }

        .auth-footer-main a:hover {
            text-decoration: underline;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .back-arrow {
                padding: 16px;
                top: 20px;
            }
            
            .back-link span {
                display: none;
            }
            
            .back-link {
                padding: 10px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                justify-content: center;
            }
            
            .auth-main {
                padding: 20px 16px;
                align-items: center;
                padding-top: 80px;
            }
            
            .auth-wrapper {
                padding: 30px 20px;
                border-radius: 12px;
            }
            
            .auth-header h2 {
                font-size: 1.5rem;
            }
            
            .verification-code-input {
                gap: 8px;
            }
            
            .verification-code-input input {
                width: 45px;
                height: 55px;
                font-size: 1.3rem;
            }
            
            .input-with-icon input,
            .input-with-icon select {
                padding: 14px 14px 14px 44px;
            }
            
            .submit-btn {
                padding: 14px;
                font-size: 1rem;
            }
            
            .success-icon {
                font-size: 3rem;
            }
            
            .success-message h2 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .auth-wrapper {
                padding: 24px 16px;
            }
            
            .auth-header h2 {
                font-size: 1.3rem;
            }
            
            .verification-code-input {
                gap: 5px;
            }
            
            .verification-code-input input {
                width: 40px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .verification-icon i {
                font-size: 2.5rem;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .auth-footer p {
                font-size: 0.9rem;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for accessibility */
        input:focus-visible,
        select:focus-visible,
        button:focus-visible {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }

        /* Back to Home button styling */
        .back-home-container {
            background-color: #fef9f0;
            padding: 15px 24px;
            margin-top: 60px;
            border-bottom: 1px solid #eee;
        }

        .back-home-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #2c3e50;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            background-color: white;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }

        .back-home-button:hover {
            background-color: #f5f5f5;
            border-color: #3498db;
            color: #3498db;
        }
    </style>
</head>
<body>
    <!-- Header - Only shows on PC -->
    <header class="header">
        <div class="top-row">
            <div class="top-left">
                <a href="index.html" class="top-link">Home</a>
                <a href="sign.html" class="top-link active">Sign In</a>
                <a href="#" class="top-link">Marketplace</a>
                <a href="#" class="top-link">Safety Tips</a>
                <a href="#" class="top-link">Help / Support</a>
            </div>
            <div class="top-right" id="auth-links">
                <!-- Will be dynamically populated by JavaScript -->
            </div>
        </div>
    </header>

    <!-- Main container -->
    <div class="fullscreen-container">
        
        <!-- Back to Home navigation (mobile and desktop) -->
        <div class="back-arrow">
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Home</span>
            </a>
        </div>
        
        <!-- Main content area -->
        <main class="auth-main">
            <!-- Sign In Form -->
            <div id="signin-page" class="auth-page active">
                <div class="auth-wrapper">
                    <div class="auth-header">
                        <h2>Welcome to U-Mall</h2>
                        <p>Sign in to your account to continue</p>
                    </div>
                    
                    <form id="signinForm" class="auth-form">
                        <div class="form-group">
                            <label for="signin-email">Email Address</label>
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="signin-email" name="email" placeholder="Enter your email" required>
                            </div>
                            <div class="error-message" id="signin-email-error"></div>
                        </div>
                        
                        <div class="form-group">
                            <div class="password-label-row">
                                <label for="signin-password">Password</label>
                                <a href="#" id="forgot-password-link" class="forgot-password">Forgot Password?</a>
                            </div>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="signin-password" name="password" placeholder="Enter your password" required>
                                <button type="button" class="toggle-password" data-target="signin-password" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="error-message" id="signin-password-error"></div>
                        </div>
                        
                        <button type="submit" class="submit-btn">Sign In</button>
                        
                        <div class="auth-footer">
                            <p>Don't have an account? <a href="#" id="go-to-signup">Sign Up</a></p>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Sign Up Form - Simplified -->
            <div id="signup-page" class="auth-page">
                <div class="auth-wrapper">
                    <div class="auth-header">
                        <h2>Join U-Mall</h2>
                        <p>Start by verifying your campus email</p>
                    </div>
                    
                    <form id="signupForm" class="auth-form">
                        <div class="form-group">
                            <label for="signup-email">Campus Email Address</label>
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="signup-email" name="email" placeholder="student@university.edu" required>
                            </div>
                            <div class="error-message" id="signup-email-error"></div>
                        </div>
                        
                        <button type="submit" class="submit-btn" id="verify-email-btn">Send Verification Code</button>
                        
                        <div class="auth-footer">
                            <p>Already have an account? <a href="#" id="go-to-signin">Sign In</a></p>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Email Verification Form -->
            <div id="verification-page" class="auth-page">
                <div class="auth-wrapper">
                    <div class="auth-header">
                        <div class="verification-icon">
                            <i class="fas fa-envelope-circle-check"></i>
                        </div>
                        <h2>Verify Your Email</h2>
                        <p>Code sent to <span id="verification-email-display"></span></p>
                        <p class="verification-subtitle">Enter the 6-digit code to continue</p>
                    </div>
                    
                    <form id="verificationForm" class="auth-form">
                        <div class="form-group">
                            <div class="verification-code-input">
                                <input type="text" id="code1" maxlength="1" required autofocus inputmode="numeric">
                                <input type="text" id="code2" maxlength="1" required inputmode="numeric">
                                <input type="text" id="code3" maxlength="1" required inputmode="numeric">
                                <input type="text" id="code4" maxlength="1" required inputmode="numeric">
                                <input type="text" id="code5" maxlength="1" required inputmode="numeric">
                                <input type="text" id="code6" maxlength="1" required inputmode="numeric">
                            </div>
                            <div class="error-message" id="verification-code-error"></div>
                        </div>
                        
                        <button type="submit" class="submit-btn">Verify & Continue</button>
                        
                        <div class="auth-footer">
                            <p>Wrong email? <a href="#" id="back-to-signup">Go Back</a></p>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Password Setup Form -->
            <div id="password-setup-page" class="auth-page">
                <div class="auth-wrapper">
                    <div class="auth-header">
                        <h2>Set Your Password</h2>
                        <p>Create a secure password for your account</p>
                    </div>
                    
                    <form id="passwordSetupForm" class="auth-form">
                        <div class="form-group">
                            <label for="signup-password">Password</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="signup-password" name="password" placeholder="Create a password" required disabled>
                                <button type="button" class="toggle-password" data-target="signup-password" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="error-message" id="signup-password-error"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">Confirm Password</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirm your password" required disabled>
                                <button type="button" class="toggle-password" data-target="confirm-password" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="error-message" id="confirm-password-error"></div>
                        </div>
                        
                        <button type="submit" class="submit-btn">Create Account</button>
                    </form>
                </div>
            </div>
            
            <!-- Success Message -->
            <div id="signup-success-page" class="auth-page">
                <div class="auth-wrapper">
                    <div class="success-message">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h2>Account Created!</h2>
                        <p>Your account is now active. You can sign in.</p>
                        <button id="go-to-signin-from-success" class="submit-btn">Sign In Now</button>
                    </div>
                </div>
            </div>
            
            <!-- Reset Password Form -->
            <div id="reset-request-page" class="auth-page">
                <div class="auth-wrapper">
                    <div class="auth-header">
                        <h2>Reset Password</h2>
                        <p>Enter your email to receive reset instructions</p>
                    </div>
                    
                    <form id="resetRequestForm" class="auth-form">
                        <div class="form-group">
                            <label for="reset-email">Email Address</label>
                            <div class="input-with-icon">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="reset-email" name="email" placeholder="Enter your email" required>
                            </div>
                            <div class="error-message" id="reset-email-error"></div>
                        </div>
                        
                        <button type="submit" class="submit-btn">Send Reset Code</button>
                        
                        <div class="auth-footer">
                            <p>Remember password? <a href="#" id="back-to-signin-from-reset">Back to Sign In</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </main>
        
        <footer class="auth-footer-main">
            <p>Cell Noun Campus Marketplace &copy; 2024</p>
        </footer>
    </div>

    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        /**
         * Cell Noun Authentication - Complete Self-Contained Version
         * Email-first verification flow with header authentication state management
         */

        document.addEventListener('DOMContentLoaded', function() {
            // State management
            let state = {
                userEmail: '',
                verificationCode: '',
                isVerified: false
            };
            
            // DOM elements
            const pages = {
                signin: document.getElementById('signin-page'),
                signup: document.getElementById('signup-page'),
                verify: document.getElementById('verification-page'),
                password: document.getElementById('password-setup-page'),
                success: document.getElementById('signup-success-page'),
                reset: document.getElementById('reset-request-page')
            };
            
            // Forms
            const signinForm = document.getElementById('signinForm');
            const signupForm = document.getElementById('signupForm');
            const verifyForm = document.getElementById('verificationForm');
            const passwordForm = document.getElementById('passwordSetupForm');
            const resetForm = document.getElementById('resetRequestForm');
            
            // Inputs
            const codeInputs = Array.from({length: 6}, (_, i) => 
                document.getElementById(`code${i + 1}`)
            );
            
            // Header authentication links container
            const authLinksContainer = document.getElementById('auth-links');
            
            // Initialize EmailJS
            emailjs.init({
                publicKey: 'AOiNoUc43ZE09tlGZ',
                blockHeadless: true
            });
            
            // Initialize
            init();
            
            function init() {
                setupEventListeners();
                setupVerificationInputs();
                updateAuthLinks();
                
                // Check URL for page
                const hash = window.location.hash.substring(1);
                if (hash && pages[hash]) {
                    showPage(hash);
                }
                
                // Check if user is already logged in
                checkLoggedInStatus();
            }
            
            function showPage(pageName) {
                // Hide all pages
                Object.values(pages).forEach(page => {
                    if (page) page.classList.remove('active');
                });
                
                // Show requested page
                if (pages[pageName]) {
                    pages[pageName].classList.add('active');
                    window.location.hash = pageName;
                }
                
                // Clear errors
                clearErrors();
            }
            
            function clearErrors() {
                document.querySelectorAll('.error-message').forEach(el => {
                    el.textContent = '';
                });
            }
            
            function showError(elementId, message) {
                const el = document.getElementById(elementId);
                if (el) el.textContent = message;
            }
            
            /**
             * Check if user is logged in and update header accordingly
             */
            function checkLoggedInStatus() {
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    updateAuthLinks();
                }
            }
            
            /**
             * Update authentication links in header
             */
            function updateAuthLinks() {
                if (!authLinksContainer) return;
                
                const currentUser = localStorage.getItem('currentUser');
                
                if (currentUser) {
                    // User is logged in - show logout
                    authLinksContainer.innerHTML = `
                        <a href="profile.html" class="top-link">Profile</a>
                        <a href="#" class="top-link" id="header-logout-link">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    `;
                    
                    // Add event listener to header logout link
                    const headerLogoutLink = document.getElementById('header-logout-link');
                    if (headerLogoutLink) {
                        headerLogoutLink.addEventListener('click', handleLogout);
                    }
                } else {
                    // User is not logged in - show login/register
                    authLinksContainer.innerHTML = `
                        <a href="#signin" class="top-link">Login</a>
                        <span class="slash">/</span>
                        <a href="#signup" class="top-link">Register</a>
                    `;
                }
            }
            
            // Event Listeners
            function setupEventListeners() {
                // Navigation
                document.getElementById('go-to-signup')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('signup');
                });
                
                document.getElementById('go-to-signin')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('signin');
                });
                
                document.getElementById('back-to-signup')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('signup');
                });
                
                document.getElementById('forgot-password-link')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('reset');
                });
                
                document.getElementById('back-to-signin-from-reset')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('signin');
                });
                
                document.getElementById('go-to-signin-from-success')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('signin');
                });
                
                // Form submissions
                signupForm?.addEventListener('submit', handleEmailVerification);
                verifyForm?.addEventListener('submit', handleCodeVerification);
                passwordForm?.addEventListener('submit', handlePasswordSetup);
                signinForm?.addEventListener('submit', handleSignIn);
                resetForm?.addEventListener('submit', handlePasswordReset);
                
                // Password toggles
                document.querySelectorAll('.toggle-password').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const target = this.getAttribute('data-target');
                        const input = document.getElementById(target);
                        const icon = this.querySelector('i');
                        
                        if (input && icon) {
                            const isPassword = input.type === 'password';
                            input.type = isPassword ? 'text' : 'password';
                            icon.className = isPassword ? 'fas fa-eye-slash' : 'fas fa-eye';
                        }
                    });
                });
            }
            
            // Email verification handler
            async function handleEmailVerification(e) {
                e.preventDefault();
                clearErrors();
                
                const email = document.getElementById('signup-email').value.trim();
                
                if (!email) {
                    showError('signup-email-error', 'Email is required');
                    return;
                }
                
                if (!isValidEmail(email)) {
                    showError('signup-email-error', 'Please enter a valid email');
                    return;
                }
                
                // Store email in state
                state.userEmail = email;
                
                // Generate and send verification code
                state.verificationCode = generateCode();
                console.log('Generated code:', state.verificationCode); // For debugging
                
                try {
                    const sent = await sendEmail(email, state.verificationCode, 'verification');
                    
                    if (sent) {
                        // Update UI and show verification page
                        document.getElementById('verification-email-display').textContent = email;
                        showPage('verify');
                        
                        // Clear email input
                        document.getElementById('signup-email').value = '';
                    }
                } catch (error) {
                    showError('signup-email-error', 'Failed to send verification email');
                    console.error('Email error:', error);
                    
                    // Fallback: show code for testing
                    alert(`For testing: Your code is ${state.verificationCode}`);
                    document.getElementById('verification-email-display').textContent = email;
                    showPage('verify');
                }
            }
            
            // Code verification handler
            function handleCodeVerification(e) {
                e.preventDefault();
                
                const enteredCode = codeInputs.map(input => input.value).join('');
                
                if (enteredCode.length !== 6) {
                    showError('verification-code-error', 'Please enter the complete code');
                    return;
                }
                
                if (enteredCode === state.verificationCode) {
                    state.isVerified = true;
                    
                    // Enable password fields
                    const passwordFields = ['signup-password', 'confirm-password'];
                    passwordFields.forEach(id => {
                        const field = document.getElementById(id);
                        if (field) {
                            field.disabled = false;
                            field.focus();
                        }
                    });
                    
                    showPage('password');
                    clearErrors();
                } else {
                    showError('verification-code-error', 'Incorrect verification code');
                    
                    // Clear inputs on wrong code
                    codeInputs.forEach(input => {
                        input.value = '';
                        input.classList.remove('verified');
                    });
                    codeInputs[0].focus();
                }
            }
            
            // Password setup handler
            function handlePasswordSetup(e) {
                e.preventDefault();
                clearErrors();
                
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('confirm-password').value;
                
                // Validate password
                const passwordValid = validatePassword(password);
                if (!passwordValid.valid) {
                    showError('signup-password-error', passwordValid.message);
                    return;
                }
                
                if (password !== confirm) {
                    showError('confirm-password-error', 'Passwords do not match');
                    return;
                }
                
                // Save user to localStorage
                saveUser(state.userEmail, password);
                
                // Show success page
                showPage('success');
                
                // Reset state
                state = { userEmail: '', verificationCode: '', isVerified: false };
            }
            
            // Sign in handler
            function handleSignIn(e) {
                e.preventDefault();
                clearErrors();
                
                const email = document.getElementById('signin-email').value.trim();
                const password = document.getElementById('signin-password').value;
                
                // Validate
                if (!email || !password) {
                    showError('signin-email-error', 'Email and password are required');
                    return;
                }
                
                // Check user exists (from localStorage)
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.email === email);
                
                if (!user) {
                    showError('signin-email-error', 'No account found with this email');
                    return;
                }
                
                if (user.password !== password) {
                    showError('signin-password-error', 'Incorrect password');
                    return;
                }
                
                // Save session
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Update header to show logout
                updateAuthLinks();
                
                // Redirect to home page
                window.location.href = 'index.html';
            }
            
            // Password reset handler
            async function handlePasswordReset(e) {
                e.preventDefault();
                clearErrors();
                
                const email = document.getElementById('reset-email').value.trim();
                
                if (!email) {
                    showError('reset-email-error', 'Email is required');
                    return;
                }
                
                // Check if user exists
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userExists = users.some(u => u.email === email);
                
                if (!userExists) {
                    showError('reset-email-error', 'No account found with this email');
                    return;
                }
                
                // Generate reset code
                const resetCode = generateCode();
                console.log('Reset code:', resetCode); // For debugging
                
                try {
                    const sent = await sendEmail(email, resetCode, 'reset');
                    
                    if (sent) {
                        alert(`Reset code sent to ${email}\nFor testing, code is: ${resetCode}`);
                        showPage('signin');
                    }
                } catch (error) {
                    showError('reset-email-error', 'Failed to send reset email');
                    console.error('Reset email error:', error);
                }
            }
            
            /**
             * Handle logout from header
             */
            function handleLogout(e) {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    // Clear localStorage
                    localStorage.removeItem('currentUser');
                    
                    // Update header
                    updateAuthLinks();
                    
                    // If on profile page, redirect to home
                    if (window.location.pathname.includes('profile.html')) {
                        window.location.href = 'index.html';
                    } else {
                        // Refresh the current page
                        window.location.reload();
                    }
                }
            }
            
            // Email sending function
            async function sendEmail(to, code, type) {
                try {
                    const templateId = type === 'verification' 
                        ? 'template_mgdn1p7' 
                        : 'template_90nk5yc';
                    
                    const response = await emailjs.send(
                        'service_gb5yh0l',
                        templateId,
                        {
                            to_email: to,
                            verification_code: code,
                            app_name: 'U-Mall'
                        }
                    );
                    
                    return response.status === 200;
                } catch (error) {
                    console.error('EmailJS error:', error);
                    throw error;
                }
            }
            
            // Helper functions
            function setupVerificationInputs() {
                codeInputs.forEach((input, index) => {
                    if (!input) return;
                    
                    input.addEventListener('input', function(e) {
                        const value = this.value;
                        
                        // Only allow numbers
                        if (!/^\d*$/.test(value)) {
                            this.value = '';
                            return;
                        }
                        
                        // Auto-advance
                        if (value && index < codeInputs.length - 1) {
                            codeInputs[index + 1].focus();
                        }
                    });
                    
                    // Handle backspace
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && !this.value && index > 0) {
                            codeInputs[index - 1].focus();
                        }
                    });
                });
            }
            
            function generateCode() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }
            
            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }
            
            function validatePassword(password) {
                if (password.length < 8) {
                    return { valid: false, message: 'Password must be at least 8 characters' };
                }
                
                if (!/[a-zA-Z]/.test(password)) {
                    return { valid: false, message: 'Password must contain letters' };
                }
                
                if (!/\d/.test(password)) {
                    return { valid: false, message: 'Password must contain numbers' };
                }
                
                return { valid: true, message: '' };
            }
            
            function saveUser(email, password) {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                // Remove existing user if any
                const filteredUsers = users.filter(u => u.email !== email);
                
                // Add new user
                const user = {
                    id: Date.now().toString(),
                    email: email,
                    password: password,
                    verified: true,
                    createdAt: new Date().toISOString(),
                    username: email.split('@')[0] // Generate username from email
                };
                
                filteredUsers.push(user);
                localStorage.setItem('users', JSON.stringify(filteredUsers));
                
                console.log('User saved:', user);
            }
        });
    </script>
</body>
</html>